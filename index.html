<!DOCTYPE html>
<html lang="en" data-theme="serenity">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Daily Question - A private, offline-first journaling app.">
    <meta name="theme-color" content="#fdf6e3">
    <title>Daily Question</title>
    
    <!-- PWA Manifest (Embedded) -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRGFpbHkgUXVlc3Rpb24iLCJzaG9ydF9uYW1lIjoiRGFpbHkgUSIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZGY2ZTMiLCJ0aGVtZV9jb2xvciI6IiNiNTg5MDAiLCJpY29ucyI6W119">

    <style>
        /* =========================================
           1. CSS VARIABLES & THEMES
           ========================================= */
        :root {
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --nav-height-mobile: 65px;
            --nav-height-desktop: 80px;
        }

        /* 1. Serenity (Default - Warm/Paper) */
        [data-theme="serenity"] {
            --bg-body: #fdf6e3;
            --bg-card: #ffffff;
            --bg-nav: #ffffff;
            --text-main: #5c4934;
            --text-muted: #93836c;
            --primary: #b58900;
            --accent: #cb4b16;
            --border: #efe6d0;
            --shadow: 0 4px 20px rgba(92, 73, 52, 0.08);
        }

        /* 2. Midnight (Deep Blue/Purple) */
        [data-theme="midnight"] {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-nav: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --primary: #818cf8;
            --accent: #c084fc;
            --border: #334155;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        /* 3. Forest (Nature/Green) */
        [data-theme="forest"] {
            --bg-body: #edFAF0;
            --bg-card: #ffffff;
            --bg-nav: #ffffff;
            --text-main: #2d382e;
            --text-muted: #789c7b;
            --primary: #4a7c59;
            --accent: #d4a373;
            --border: #dbece0;
            --shadow: 0 4px 20px rgba(45, 56, 46, 0.08);
        }

        /* 4. Rose (Soft Pink) */
        [data-theme="rose"] {
            --bg-body: #fff0f5;
            --bg-card: #ffffff;
            --bg-nav: #ffffff;
            --text-main: #883e56;
            --text-muted: #bc8a9f;
            --primary: #d67595;
            --accent: #f2aebf;
            --border: #fce4ec;
            --shadow: 0 4px 20px rgba(136, 62, 86, 0.08);
        }

        /* 5. Ocean (Teal/Calm) */
        [data-theme="ocean"] {
            --bg-body: #f0f8ff;
            --bg-card: #ffffff;
            --bg-nav: #ffffff;
            --text-main: #2c5282;
            --text-muted: #7d9cb8;
            --primary: #319795;
            --accent: #4fd1c5;
            --border: #e2e8f0;
            --shadow: 0 4px 20px rgba(44, 82, 130, 0.08);
        }

        /* 6. Stark (High Contrast/Monochrome) */
        [data-theme="stark"] {
            --bg-body: #ffffff;
            --bg-card: #f8f9fa;
            --bg-nav: #ffffff;
            --text-main: #000000;
            --text-muted: #6c757d;
            --primary: #212529;
            --accent: #495057;
            --border: #dee2e6;
            --shadow: none; /* Flat design */
        }

        /* 7. Sunset (Gradient Vibes) */
        [data-theme="sunset"] {
            --bg-body: #2d1b2e;
            --bg-card: #452442;
            --bg-nav: #452442;
            --text-main: #ffebd4;
            --text-muted: #b08d9e;
            --primary: #ff9e64;
            --accent: #ff6b6b;
            --border: #5c3a58;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        /* 8. Cyber (Neon/Dark) */
        [data-theme="cyber"] {
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --bg-nav: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #757575;
            --primary: #00e676;
            --accent: #2979ff;
            --border: #333333;
            --shadow: 0 4px 20px rgba(0, 230, 118, 0.1);
        }

        /* =========================================
           2. RESET & BASE STYLES
           ========================================= */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-stack);
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.4s ease, color 0.4s ease;
            overflow: hidden; /* Prevent body scroll, handle in main */
        }

        /* =========================================
           3. LAYOUT & NAVIGATION
           ========================================= */
        .app-layout {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Navigation Bar */
        .nav-bar {
            background-color: var(--bg-nav);
            border-top: 1px solid var(--border);
            height: var(--nav-height-mobile);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.02);
        }

        .nav-item {
            border: none;
            background: none;
            color: var(--text-muted);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }
        
        .nav-icon { font-size: 1.4rem; transition: transform 0.2s; }
        .nav-label { font-size: 0.7rem; font-weight: 500; }
        
        .nav-item.active { color: var(--primary); }
        .nav-item.active .nav-icon { transform: translateY(-2px); }
        .nav-item:hover { color: var(--text-main); }

        /* Main Content Area */
        .main-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            scroll-behavior: smooth;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding-bottom: 40px;
        }

        /* Views */
        .view { display: none; animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .view.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* =========================================
           4. COMPONENTS
           ========================================= */
        /* Typography */
        h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; letter-spacing: -0.5px; }
        h2 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; }
        h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .text-muted { color: var(--text-muted); font-size: 0.9rem; }
        .text-center { text-align: center; }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        /* Buttons */
        .btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 10px 20px;
            border-radius: var(--radius-lg);
            font-size: 0.95rem;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover { background: var(--border); transform: translateY(-1px); }
        .btn:active { transform: scale(0.98); }
        
        .btn-primary {
            background: var(--primary);
            color: var(--bg-card); /* Inverted text for contrast */
            border-color: var(--primary);
        }
        .btn-primary:hover { opacity: 0.9; background: var(--primary); }

        .btn-icon { padding: 8px; border-radius: 50%; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-muted); background: transparent; }
        .btn-icon:hover { color: var(--primary); background: var(--border); }

        /* Form Elements */
        textarea {
            width: 100%;
            min-height: 180px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: 1.1rem;
            color: var(--text-main);
            resize: none;
            outline: none;
            line-height: 1.7;
            padding: 10px 0;
        }
        textarea::placeholder { color: var(--text-muted); opacity: 0.6; }

        input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-body);
            color: var(--text-main);
            font-family: inherit;
            outline: none;
        }
        input[type="text"]:focus { border-color: var(--primary); }

        /* Custom Mood Selector */
        .mood-selector { display: flex; justify-content: space-between; margin-top: 1rem; border-top: 1px solid var(--border); padding-top: 1rem; }
        .mood-opt { font-size: 1.8rem; cursor: pointer; opacity: 0.4; transition: var(--transition); transform: scale(0.9); border: none; background: none; }
        .mood-opt:hover { opacity: 0.8; transform: scale(1.1); }
        .mood-opt.selected { opacity: 1; transform: scale(1.2); text-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            background: var(--border);
            color: var(--text-main);
            margin-bottom: 10px;
        }

        /* Stats Heatmap */
        .heatmap-container { display: flex; flex-wrap: wrap; gap: 3px; justify-content: flex-start; }
        .day-cell { width: 10px; height: 10px; background: var(--border); border-radius: 2px; opacity: 0.5; }
        .day-cell.l1 { background: var(--primary); opacity: 0.3; }
        .day-cell.l2 { background: var(--primary); opacity: 0.6; }
        .day-cell.l3 { background: var(--primary); opacity: 0.8; }
        .day-cell.l4 { background: var(--primary); opacity: 1.0; }

        /* Theme Grid */
        .theme-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 12px; }
        .theme-swatch { height: 60px; border-radius: var(--radius-sm); cursor: pointer; border: 2px solid transparent; position: relative; }
        .theme-swatch.active { border-color: var(--text-main); box-shadow: 0 0 0 2px var(--bg-card); }

        /* Journal List */
        .entry-item { padding: 16px 0; border-bottom: 1px solid var(--border); animation: fadeIn 0.3s ease; }
        .entry-item:last-child { border-bottom: none; }
        .entry-date { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px; display: flex; justify-content: space-between; }
        .entry-q { font-weight: 600; margin-bottom: 6px; color: var(--text-main); font-size: 1rem; }
        .entry-preview { color: var(--text-muted); font-size: 0.95rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* Footer */
        .app-footer {
            margin-top: 40px;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-muted);
            padding: 20px 0;
            border-top: 1px solid var(--border);
            opacity: 0.8;
        }

        /* =========================================
           5. RESPONSIVE MEDIA QUERIES
           ========================================= */
        @media (min-width: 768px) {
            .app-layout { flex-direction: column; }
            .nav-bar {
                order: -1; /* Move to top */
                height: var(--nav-height-desktop);
                border-top: none;
                border-bottom: 1px solid var(--border);
                padding: 0 40px;
                justify-content: center;
                gap: 60px;
            }
            .nav-item { flex-direction: row; gap: 8px; }
            .nav-label { font-size: 0.9rem; }
            .container { max-width: 800px; padding-top: 40px; }
            
            /* Two column stats on desktop */
            .stats-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        }
    </style>
</head>
<body>

<div class="app-layout">
    
    <!-- NAVIGATION -->
    <nav class="nav-bar">
        <button class="nav-item active" onclick="app.route('today')">
            <span class="nav-icon">‚úèÔ∏è</span>
            <span class="nav-label">Today</span>
        </button>
        <button class="nav-item" onclick="app.route('journal')">
            <span class="nav-icon">üìñ</span>
            <span class="nav-label">Journal</span>
        </button>
        <button class="nav-item" onclick="app.route('stats')">
            <span class="nav-icon">üìà</span>
            <span class="nav-label">Insights</span>
        </button>
        <button class="nav-item" onclick="app.route('settings')">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span class="nav-label">Settings</span>
        </button>
    </nav>

    <!-- MAIN SCROLLABLE AREA -->
    <main class="main-content">
        <div class="container">

            <!-- VIEW: TODAY -->
            <section id="view-today" class="view active">
                <header style="margin-bottom: 24px;">
                    <div class="text-muted" id="greeting-msg">Hello</div>
                    <h1 id="date-display">Today</h1>
                </header>

                <div class="card">
                    <span class="badge" id="q-category">Reflection</span>
                    <h2 id="q-text" style="font-weight: 500; line-height: 1.4;">Loading question...</h2>
                </div>

                <div class="card">
                    <textarea id="entry-input" placeholder="Just start writing... don't overthink it."></textarea>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <span class="text-muted" style="font-size: 0.8rem;" id="word-count">0 words</span>
                        <span class="text-muted" style="font-size: 0.8rem;" id="save-status">Synced</span>
                    </div>

                    <div class="mood-selector">
                        <button class="mood-opt" onclick="app.setMood('great')" title="Great">üòÑ</button>
                        <button class="mood-opt" onclick="app.setMood('good')" title="Good">üôÇ</button>
                        <button class="mood-opt" onclick="app.setMood('neutral')" title="Neutral">üòê</button>
                        <button class="mood-opt" onclick="app.setMood('bad')" title="Bad">üòî</button>
                        <button class="mood-opt" onclick="app.setMood('awful')" title="Awful">üò£</button>
                    </div>
                </div>

                <div class="text-center text-muted" style="font-size: 0.9rem; margin-top: 30px; font-style: italic;">
                    <span id="daily-quote">"Simplicity is the ultimate sophistication."</span>
                </div>
            </section>

            <!-- VIEW: JOURNAL -->
            <section id="view-journal" class="view">
                <header style="margin-bottom: 20px;">
                    <h1>Journal</h1>
                    <div style="margin-top: 10px;">
                        <input type="text" id="search-input" placeholder="üîç Search your thoughts..." onkeyup="app.renderJournal()">
                    </div>
                </header>
                
                <div class="card" id="journal-feed">
                    <!-- Entries go here -->
                    <div class="text-center text-muted">No entries yet. Write one today!</div>
                </div>
            </section>

            <!-- VIEW: STATS -->
            <section id="view-stats" class="view">
                <header style="margin-bottom: 20px;">
                    <h1>Insights</h1>
                </header>

                <div class="stats-wrapper">
                    <div class="card">
                        <h3>At a Glance</h3>
                        <div style="display: flex; justify-content: space-around; text-align: center; margin-top: 20px;">
                            <div>
                                <div style="font-size: 2rem; font-weight: 700; color: var(--primary);" id="stat-count">0</div>
                                <div class="text-muted" style="font-size: 0.8rem;">Entries</div>
                            </div>
                            <div>
                                <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="stat-words">0</div>
                                <div class="text-muted" style="font-size: 0.8rem;">Words</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Activity Map</h3>
                        <p class="text-muted" style="font-size: 0.8rem; margin-bottom: 10px;">Last 90 days</p>
                        <div class="heatmap-container" id="heatmap"></div>
                    </div>
                </div>
            </section>

            <!-- VIEW: SETTINGS -->
            <section id="view-settings" class="view">
                <header style="margin-bottom: 20px;">
                    <h1>Settings</h1>
                </header>

                <div class="card">
                    <h3>Theme</h3>
                    <div class="theme-grid">
                        <div class="theme-swatch" style="background: #fdf6e3;" onclick="app.setTheme('serenity')" title="Serenity"></div>
                        <div class="theme-swatch" style="background: #0f172a;" onclick="app.setTheme('midnight')" title="Midnight"></div>
                        <div class="theme-swatch" style="background: #edFAF0;" onclick="app.setTheme('forest')" title="Forest"></div>
                        <div class="theme-swatch" style="background: #fff0f5;" onclick="app.setTheme('rose')" title="Rose"></div>
                        <div class="theme-swatch" style="background: #f0f8ff;" onclick="app.setTheme('ocean')" title="Ocean"></div>
                        <div class="theme-swatch" style="background: #ffffff; border: 1px solid #ddd;" onclick="app.setTheme('stark')" title="Stark"></div>
                        <div class="theme-swatch" style="background: linear-gradient(135deg, #2d1b2e, #452442);" onclick="app.setTheme('sunset')" title="Sunset"></div>
                        <div class="theme-swatch" style="background: #121212;" onclick="app.setTheme('cyber')" title="Cyber"></div>
                    </div>
                </div>

                <div class="card">
                    <h3>Data Management</h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <button class="btn" onclick="app.exportData()">üì• Download JSON Backup</button>
                        
                        <label class="btn">
                            üì§ Import Backup
                            <input type="file" onchange="app.importData(this)" style="display: none;">
                        </label>
                        
                        <button class="btn" style="color: var(--accent); border-color: var(--accent);" onclick="app.clearData()">üóëÔ∏è Reset All Data</button>
                    </div>
                </div>

                <footer class="app-footer">
                    <p>Daily Question v2.0</p>
                    <p style="margin-top: 5px;">Made with ‚ù§Ô∏è by Aliriyaj007</p>
                </footer>
            </section>

        </div>
    </main>
</div>

<script>
/**
 * =========================================
 *  DATA & CONFIG
 * =========================================
 */
const QUESTIONS = [
    { t: "What is one small win you had today?", c: "Gratitude" },
    { t: "What was the most challenging part of your day?", c: "Reflection" },
    { t: "Who did you connect with today, and how?", c: "Social" },
    { t: "What is something you learned today?", c: "Growth" },
    { t: "How did you take care of your body today?", c: "Health" },
    { t: "What made you smile recently?", c: "Joy" },
    { t: "What is worrying you right now?", c: "Mindfulness" },
    { t: "What are you looking forward to tomorrow?", c: "Hope" },
    { t: "If you could change one decision today, what would it be?", c: "Growth" },
    { t: "Describe your day in three words.", c: "Summary" }
];

const QUOTES = [
    "The journey of a thousand miles begins with a single step.",
    "Act as if what you do makes a difference. It does.",
    "Happiness is not something ready made. It comes from your own actions.",
    "Do what you can, with what you have, where you are.",
    "The only way to do great work is to love what you do."
];

/**
 * =========================================
 *  STORAGE ENGINE
 * =========================================
 */
const Store = {
    KEYS: { ENTRIES: 'dq_entries', SETTINGS: 'dq_settings' },
    
    getEntries() {
        return JSON.parse(localStorage.getItem(this.KEYS.ENTRIES) || '{}');
    },
    
    saveEntry(date, data) {
        const entries = this.getEntries();
        // Merge existing data for this date
        entries[date] = { ...entries[date], ...data, updated: Date.now() };
        localStorage.setItem(this.KEYS.ENTRIES, JSON.stringify(entries));
    },

    getSettings() {
        return JSON.parse(localStorage.getItem(this.KEYS.SETTINGS) || '{"theme":"serenity"}');
    },

    saveSettings(settings) {
        localStorage.setItem(this.KEYS.SETTINGS, JSON.stringify(settings));
    },

    nuke() {
        localStorage.clear();
        location.reload();
    }
};

/**
 * =========================================
 *  APP LOGIC
 * =========================================
 */
const app = {
    today: new Date().toISOString().split('T')[0], // YYYY-MM-DD
    
    init() {
        // 1. Load Theme
        const settings = Store.getSettings();
        this.setTheme(settings.theme, false);

        // 2. Setup Greeting & Date
        this.setupHeader();

        // 3. Render Today View
        this.renderToday();

        // 4. Listeners
        this.attachListeners();

        // 5. Default Route
        this.route('today');
    },

    setupHeader() {
        const dateOptions = { weekday: 'long', month: 'long', day: 'numeric' };
        document.getElementById('date-display').innerText = new Date().toLocaleDateString('en-US', dateOptions);

        const hour = new Date().getHours();
        let greeting = "Good Evening";
        if (hour < 12) greeting = "Good Morning";
        else if (hour < 18) greeting = "Good Afternoon";
        document.getElementById('greeting-msg').innerText = greeting;
    },

    // --- NAVIGATION ---
    route(viewId) {
        // Toggle Views
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${viewId}`).classList.add('active');

        // Toggle Nav State
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        // Find button that calls this route
        const btn = Array.from(document.querySelectorAll('.nav-item')).find(b => b.getAttribute('onclick').includes(viewId));
        if(btn) btn.classList.add('active');

        // Render Data on view switch
        if (viewId === 'journal') this.renderJournal();
        if (viewId === 'stats') this.renderStats();
    },

    // --- TODAY VIEW ---
    renderToday() {
        // Hash date to get consistent question
        const qIndex = this.today.split('').reduce((a,b) => a + b.charCodeAt(0), 0) % QUESTIONS.length;
        const qData = QUESTIONS[qIndex];
        
        document.getElementById('q-text').innerText = qData.t;
        document.getElementById('q-category').innerText = qData.c;
        document.getElementById('daily-quote').innerText = QUOTES[Math.floor(Math.random() * QUOTES.length)];

        // Load existing entry
        const entries = Store.getEntries();
        const entry = entries[this.today] || {};

        const textarea = document.getElementById('entry-input');
        textarea.value = entry.text || "";
        this.updateWordCount(textarea.value);
        
        // Highlight mood
        if (entry.mood) {
            document.querySelectorAll('.mood-opt').forEach(btn => {
                if(btn.getAttribute('onclick').includes(entry.mood)) btn.classList.add('selected');
            });
        }
        
        // Save Question context if not exists
        if (!entry.question) {
            Store.saveEntry(this.today, { question: qData.t, category: qData.c });
        }
    },

    setMood(mood) {
        document.querySelectorAll('.mood-opt').forEach(b => b.classList.remove('selected'));
        // Find the clicked button broadly (simplified)
        event.target.classList.add('selected');
        Store.saveEntry(this.today, { mood: mood });
    },

    updateWordCount(text) {
        const count = text.trim().split(/\s+/).filter(x => x).length;
        document.getElementById('word-count').innerText = `${count} words`;
    },

    // --- JOURNAL VIEW ---
    renderJournal() {
        const query = document.getElementById('search-input').value.toLowerCase();
        const container = document.getElementById('journal-feed');
        const entries = Store.getEntries();
        const dates = Object.keys(entries).sort().reverse();

        let html = '';
        let hasContent = false;

        dates.forEach(date => {
            const e = entries[date];
            if (!e.text) return; // Skip empty
            
            // Search Filter
            if (query && !e.text.toLowerCase().includes(query) && !e.question.toLowerCase().includes(query)) return;

            hasContent = true;
            const niceDate = new Date(date).toLocaleDateString(undefined, { month:'short', day:'numeric', year: 'numeric' });
            
            const moodMap = { great:'üòÑ', good:'üôÇ', neutral:'üòê', bad:'üòî', awful:'üò£' };
            const moodIcon = moodMap[e.mood] || '';

            html += `
                <div class="entry-item">
                    <div class="entry-date">
                        <span>${niceDate}</span>
                        <span>${moodIcon}</span>
                    </div>
                    <div class="entry-q">${e.question}</div>
                    <div class="entry-preview">${e.text}</div>
                </div>
            `;
        });

        if (!hasContent) html = `<div class="text-center text-muted" style="margin-top:20px;">No entries found.</div>`;
        container.innerHTML = html;
    },

    // --- STATS VIEW ---
    renderStats() {
        const entries = Store.getEntries();
        const dates = Object.keys(entries);
        let totalWords = 0;
        let entryCount = 0;

        // Reset Heatmap
        const heatmap = document.getElementById('heatmap');
        heatmap.innerHTML = '';

        // Generate Heatmap (Last 90 days)
        for (let i = 89; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            const iso = d.toISOString().split('T')[0];
            
            const div = document.createElement('div');
            div.className = 'day-cell';
            div.title = iso;

            if (entries[iso] && entries[iso].text) {
                const w = entries[iso].text.length;
                if(w > 500) div.classList.add('l4');
                else if(w > 200) div.classList.add('l3');
                else if(w > 50) div.classList.add('l2');
                else div.classList.add('l1');
                
                entryCount++;
                totalWords += entries[iso].text.trim().split(/\s+/).filter(x=>x).length;
            }
            heatmap.appendChild(div);
        }

        document.getElementById('stat-count').innerText = entryCount;
        document.getElementById('stat-words').innerText = totalWords;
    },

    // --- SETTINGS ---
    setTheme(name, save = true) {
        document.documentElement.setAttribute('data-theme', name);
        
        // Update UI selection
        document.querySelectorAll('.theme-swatch').forEach(el => {
            el.classList.remove('active');
            if(el.getAttribute('onclick').includes(name)) el.classList.add('active');
        });

        if(save) {
            const s = Store.getSettings();
            s.theme = name;
            Store.saveSettings(s);
        }
    },

    exportData() {
        const data = { 
            entries: Store.getEntries(), 
            settings: Store.getSettings(), 
            exportDate: new Date() 
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `daily-question-${this.today}.json`;
        a.click();
    },

    importData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const d = JSON.parse(e.target.result);
                localStorage.setItem(Store.KEYS.ENTRIES, JSON.stringify(d.entries));
                localStorage.setItem(Store.KEYS.SETTINGS, JSON.stringify(d.settings));
                alert('Import successful! Refreshing...');
                location.reload();
            } catch(err) {
                alert('Invalid file format.');
            }
        };
        reader.readAsText(file);
    },

    clearData() {
        if(confirm("Are you sure? This will delete all journal entries.")) {
            Store.nuke();
        }
    },

    attachListeners() {
        // Auto-save logic
        const input = document.getElementById('entry-input');
        let timeout;
        input.addEventListener('input', () => {
            document.getElementById('save-status').innerText = 'Saving...';
            this.updateWordCount(input.value);
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                Store.saveEntry(this.today, { text: input.value });
                document.getElementById('save-status').innerText = 'Synced';
            }, 800);
        });
    }
};

// Start
window.addEventListener('DOMContentLoaded', () => app.init());

</script>
</body>
</html>